<div class="invoice" style="border: 10px solid #f4f4f4">

  <div class="invoice">
    <div class="box box-info">
      <div class="box-header with-border text-center">
        <h3 class="box-title">Event Details</h3>
      </div>
      <div class='form-horizontal event'>
        <div class="row">
        <div class="col-md-4">
          <% if @event.video_url.present? %>
            <%= video_tag @event.video_url, :size => "320x240", :controls => true %>
          <%else%>
            <%= image_tag(@event.cover_image, style: "width: 100%") %>
          <%end%>
        </div>
          <div class="col-md-8">

            <div class="table-responsive" style="margin-top: 20px;">
          <table class="table">
            <tbody>
            <tr>
              <th style="width:25%">Title:</th>
              <td><%= @event.title %></td>
              <th>Description:</th>
              <td><%= @event.description %></td>
            </tr>
            <tr>
              <th>Start Date:</th>
              <td><%= @event.start_date&.to_date %></td>
              <th>End Date:</th>
              <td><%= @event.end_date&.to_date %></td>
            </tr>
            <tr>
              <th>Organizer:</th>
              <td><%= @event.owner&.fullname %></td>
            </tr>
            </tbody></table>
        </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <%# if @event.is_paid? %>
    
  <%# end %>

  
</div>
<script>
  $(function() {
    $("#error_box").hide();

    function hide_butons(){
      $(".stripe-section-btn").hide();
      $(".free-section-btn").hide();
    }
    hide_butons();
    $(".reset").on("click", function () {
      $(".total_price").text("$0.00");
      set_stripe_price();
      hide_butons();
    });

    $(".fieldBg").on("change", function () {
      $(".total_price").text("$0.00");
      all_tickets= [];

      total_tickets = 0;
      $(".fieldBg").each(function( index ) {
        var ticket = $(this).val();
        var package_id = $(this).data("package_id");
        if ((ticket != "") && !(isNaN(ticket))){
          var price = parseFloat($($(this)).parent().parent().find(".price").text().replace("$",""));
          var total_price = parseFloat($(".total_price").text().replace("$",""));
          new_price = (ticket * price) + total_price;
          $(".total_price").text("$"+new_price.toFixed(2));
          total_tickets += ticket;
          all_tickets.push({"ticket_package_id":package_id, "count": ticket});
          console.log(ticket+"df");
        }
      });
      $('[name="ticket_attributes[]"]').val(JSON.stringify(all_tickets));

      //Check if tickets are available
      $.ajax({
        url: "/charges/validate_tickets_count",
        type: "GET",
        data: {"ticket_attributes" : $('[name="ticket_attributes[]"]').val()},
        dataType: "json",
        success: function(data) {
          $("#error_box").text('');
          $("#error_box").hide();
          //show/hide registration buttons
          if(total_tickets > 0) {
            if (parseFloat($(".total_price").text().replace("$","")) > 0) {
              $(".stripe-section-btn").show();
              $(".free-section-btn").hide();
            }
            else {
              $(".stripe-section-btn").hide();
              $(".free-section-btn").show();
            }
          }
          else{
            hide_butons();
          }
          update_data();
        },
        error: function(data){
          $("#error_box").text(data.responseJSON.error);
          $("#error_box").show();
          hide_butons();
          update_data();
        }
      });


    });

    function update_data() {
      total_tickets = 0;
      all_tickets= [];
      set_stripe_price();
    }

    function set_stripe_price(){
      var pp = parseFloat($(".total_price").text().replace("$",""));
      $("#amount").val(pp);
      StripeCheckout.__app.configurations.button0.amount = parseFloat($(".total_price").text().replace("$",""))*100;
    }


    $('#purchase_tickets').on("click", function () {
      validate_form();
      if ($(".error").length == 0){
        $("#ticket_purchase_form").submit();
      }
    });
    $("#ticket_purchase_form input").on("focusout", function(){
      validate_form();
    });
    $("#ticket_purchase_form :input[type=email]").on("focusout", function(){
      validate_form();
    });
//    purchase_tickets
    function validate_form(){
//      e.preventDefault();
      var first_name = $('#first_name').val();
      var last_name = $('#last_name').val();
      var email = $('#email').val();
      var password = $('#phone').val();

      $(".error").remove();

      if (first_name.length < 1) {
        $('#first_name').after('<span class="error">This field is required</span>');
      }
      if (last_name.length < 1) {
        $('#last_name').after('<span class="error">This field is required</span>');
      }
      if (email.length < 1) {
        $('#email').after('<span class="error">This field is required</span>');
      } else {
//        var regEx = /^[A-Z0-9][A-Z0-9._%+-]{0,63}@(?:[A-Z0-9-]{1,63}\.){1,125}[A-Z]{2,63}$/;
        var regEx = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        var validEmail = regEx.test(String(email).toLowerCase());
        if (!validEmail) {
          $('#email').after('<span class="error">Enter a valid email</span>');
        }
      }
      if (password.length < 8) {
        $('#phone').after('<span class="error">Phone must be at least 8 digits long</span>');
      }
    }

  });
</script>